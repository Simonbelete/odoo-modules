<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <!-- Main layout -->
    <template id="appraisal.layout" inherit_id="web.frontend_layout" primary="True" />

    <template id="appraisal_page_index">
        <t t-call="appraisal.layout">
            <form action="/appraisal/submit" method="post" role="form" style="
                        display: flex;
                        flex-direction: column;
                        gap: 100px;
                        align-items: center;
                        justify-content: center;
                        margin-top: 100px;
                        maring-bottom: 100px">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <t t-foreach="categories" t-as="category">
                    <!-- Average and total scores per category -->
                    <t t-set="total_score" t-value="0" />
                    <t t-set="question_count" t-value="0" />
                    <t t-set="answer_score" t-value="0" />

                    <table class="table table-sm" border="1" style="width: 80%; border-color: #dee2e6;">
                        <thead style="border: 30px">
                            <tr>
                                <th colspan="3" style="border: 2px solid #dee2e6; background: #dee2e6">
                                    <h4 style="text-align:center; font-weight: bold; margin: 2px" t-field="category.name" />
                                </th>
                            </tr>
                            <tr>
                                <th style="border: 2px solid #dee2e6">
                                    #
                                </th>
                                <th style="border: 2px solid #dee2e6">
                                   <p style="text-align:center; margin: 0;">Key Indicators</p>
                                </th>
                                <th style="border: 2px solid #dee2e6">
                                    Score
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="questions" t-as="question">
                                <!-- Get answer for the current question -->
                                <t t-set="answer_score" t-value="0" />
                                <t t-foreach="answers" t-as="answer">
                                    <t t-if="answer.question_id.id == question.id">
                                        <t t-set="answer_score" t-value="answer.score" />
                                    </t>
                                </t>
                                
                                <input type="hidden" name="appraisal_id" t-att-value="appraisal_id"/>
                                <input type="hidden" name="appraisal_token" t-att-value="appraisal_token"/>
                                <t t-if="category.id==question.category_id.id">
                                    <t t-set="total_score" t-value="total_score + answer_score"/>
                                    <t t-set="question_count" t-value="question_count+1" />
                                    <tr>
                                        <td><span t-field="question.sequence" /></td>
                                        <td style="width: 40%"><span t-field="question.title" /></td>
                                        <td>
                                            <t t-if="question.score_method=='selection'">
                                                <t t-foreach="question.score_selection_ids" t-as="selection">
                                                    <div>
                                                        <label>
                                                            <input type="radio" 
                                                                t-att-name="question.id" 
                                                                t-att-value="selection.value"
                                                                t-att-checked="str(selection.value)==str(answer_score)" />
                                                            <span t-field="selection.value" />
                                                            -
                                                            <span t-field="selection.description" />
                                                        </label>
                                                    </div>
                                                </t>
                                            </t>
                                            <t t-if="question.score_method=='range'">
                                                <input type="number" 
                                                    t-att-name="question.id" 
                                                    t-att-min="question.score_min"
                                                    t-att-max="question.score_max" 
                                                    t-att-value="answer_score"/>
                                                <small style="color: gray;">
                                                    <div>Minimum - <span t-field="question.score_min"/></div>
                                                    <div>Maximum - <span t-field="question.score_max"/></div>
                                                </small>
                                            </t>
                                        </td>
                                    </tr>
                                </t>
                            </t>
                        </tbody>
                        <tfoot style="font-weight: bold; font-size: 15px">
                            <tr>
                                <td></td>
                                <td><span>Total Score</span></td>
                                <td><span><t t-esc="total_score" /></span></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td><span>Average Score</span></td>
                                <td><span>
                                    <t t-set="avg_score" t-value="total_score/question_count" />
                                    <t t-esc="avg_score" />
                                </span></td>
                            </tr>
                        </tfoot>
                    </table>
                </t>
                <button type="submit" value="submit" class="btn btn-primary">
                    Submit</button>
            </form>
            
            <!-- <t t-set="categories" t-value="[]" />
            <t t-foreach="questions" t-as="q">
                <t t-set="categories" t-value="categories+[q.category_id]"/>
            </t>
            <t t-foreach="set(categories)" t-as="category">
                <div><strong t-esc="category.name"></strong></div>
                <div>
                    <t t-foreach="questions" t-as="question">
                        <t t-if="category.id==question.category_id.id">
                            <div><span t-field="question.title"/></div>
                        </t>
                    </t>
                </div>
            </t> -->
        </t>
    </template>

    <!-- Question Widget -->
    <!-- <template id="question_container">
        <input type="number" step="any" class="form-control o_survey_question_numerical_box bg-transparent text-dark rounded-0 p-0"
            t-att-value="question"/>
    </template> -->

</odoo>